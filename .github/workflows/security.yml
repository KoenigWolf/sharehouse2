name: Security Check

on:
  # PR自動実行を削除（コスト節約）
  # 代わりに /review コメントで review.yml が実行される
  schedule:
    # 毎週月曜 9:00 JST (日曜 24:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Run npm audit (web)
        id: audit-web
        run: |
          npm audit --audit-level=high --json > audit-web.json 2>&1 || true
          HIGH_COUNT=$(cat audit-web.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_COUNT=$(cat audit-web.json | jq '.metadata.vulnerabilities.critical // 0')
          echo "high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          if [ "$HIGH_COUNT" -gt 0 ] || [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Run npm audit (mobile)
        id: audit-mobile
        working-directory: mobile
        run: |
          npm audit --audit-level=high --json > audit-mobile.json 2>&1 || true
          HIGH_COUNT=$(cat audit-mobile.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_COUNT=$(cat audit-mobile.json | jq '.metadata.vulnerabilities.critical // 0')
          echo "high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          if [ "$HIGH_COUNT" -gt 0 ] || [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Report results
        run: |
          echo "=== Web Audit Results ==="
          echo "High: ${{ steps.audit-web.outputs.high }}"
          echo "Critical: ${{ steps.audit-web.outputs.critical }}"
          echo ""
          echo "=== Mobile Audit Results ==="
          echo "High: ${{ steps.audit-mobile.outputs.high }}"
          echo "Critical: ${{ steps.audit-mobile.outputs.critical }}"

      - name: Fail if critical vulnerabilities
        if: steps.audit-web.outputs.critical > 0 || steps.audit-mobile.outputs.critical > 0
        run: |
          echo "::error::Critical vulnerabilities found!"
          exit 1
